<!DOCTYPE html>
<head>
  
  <meta http-equiv='Content-type' content='text/html; charset=utf-8'>
  
  <script type="text/javascript" src="../mt.js"></script>
  <script type="text/javascript" src="../lib/cm.js"></script>
  <script type="text/javascript" src="../lib/cm/util/extras.js"></script>
  <script type="text/javascript" src="../lib/cm/Call.js"></script>
  <script type="text/javascript" src="../lib/cm/Controller.js"></script>
  <script type="text/javascript" src="../lib/cm/Transport.js"></script>
  <script type="text/javascript" src="../lib/cm/transport/WebSocketTransport.js"></script>
  <script type="text/javascript" src="../lib/cm/transport/RTCInternals.js"></script>
  <script type="text/javascript" src="../lib/cm/transport/RTCTransport.js"></script>
  <script type="text/javascript" src="../lib/cm/Session.js"></script>
  <script type="text/javascript" src="../lib/cm/User.js"></script>
  <style type="text/css">
    .selfVideo, .pairedVideo {
      border: 1px solid lightgrey;
      display: inline-block;
    }
  </style>
</head>

<body>
  <div class="selfVideo" id="selfVideo" style="width: 240px; height: 180px;"></div>
  <div class="pairedVideo" id="pairedVideo" style="width: 320px; height:240px;"></div>
  <ul id="contactList" class="contactList">

  </ul>
  
  <script id="contactTmpl" type="text/callmeTmpl">
    <li id="#{id}" class="status"><a class="contact" href="##{id}">#{name}</a></li>
  </script>

  <script id="videoTmpl" type="text/callmeTmpl">
    <video autoplay="autoplay" src="#{src}" width="#{width}" height="#{height}"></video>
  </script>


  <script type="text/javascript">

    var SELF_VIDEO_ATTRIBUTES = { width: 240, height: 180 },
        PAIRED_VIDEO_ATTRIBUTES = { width: 320, height: 240 };

    window.addEvent( "DOMContentLoaded", function() {
      var user = new CM.User({
        session: {
          transport: {
            options: {
              url: "/session"
            }
          }
        }
      }),
      contactList = $("contactList");

      CM.testSystem( function() {

        user.createSession( "" + Math.round( Math.random() * 1e15 ), function() {
          // OK
          console.log( "session created" );
        }, function() {
          // FAIL
          console.log( "failed to create session" );
        } ).on( "session.confirmed", function( data ) {
          console.log( data );
          user.refreshContacts();
        } ).on( "contacts.refresh", function( data ) {
          console.log( data )
          contactList.empty();
          var contactsHtml = "";
          if ( !CM.isEmpty( data.contacts ) ) {
            data.contacts.each( function( contact ) {
              contactsHtml += CM.tmpl( "#contactTmpl", {
                id: contact.uuid,
                name: CM.isEmpty( contact.user_data.name ) ?
                        contact.uuid :
                          CM.isEmpty( contact.user_data.name ),
                status: "online" /* @FIXME: add more meaningfull statuses */
              } );
            } );
            contactList.set( "html", contactsHtml );
          }
        } ).on( "invite", function( call ) {
          var username = ( call.userdata() && call.userdata().name ) || call.uuid();
          if ( confirm( username + " is calling you. Answer?" ) ) {
            user.startWebCam( function( videoSrc ) {
              $("selfVideo").set( "html", CM.tmpl(
                "#videoTmpl",
                Object.merge({ src: videoSrc }, SELF_VIDEO_ATTRIBUTES )
              ) );
              user.answer( call );
            }, function() {
              alert( "Error: webcam couldn't be started." );
            } );
          } else {
            user.reject( call );
          }
        } ).on( "remote.video", function( remoteVideoSrc ) {
          console.log( $("pairedVideo").set( "html", CM.tmpl(
            "#videoTmpl",
            Object.merge({ src: remoteVideoSrc }, PAIRED_VIDEO_ATTRIBUTES )
          ) ) );
        } );

        contactList.addEvent( "click:relay(a.contact)", function( e ) {
          e.preventDefault();
          var uuid = this.getParent( "li" ).get( "id" );
          user.startWebCam( function( videoSrc ) {
            $("selfVideo").set( "html", CM.tmpl(
              "#videoTmpl",
              Object.merge({ src: videoSrc }, SELF_VIDEO_ATTRIBUTES )
            ) );
            user.callTo( uuid, function( user2 ) {
              // succeed
            }, function() {
              alert( "Remote user rejected your call" );
            } );
          }, function() {
            alert( "Error: webcam couldn't be started." );
          } );
        } );

      } );
        
    } );
  </script>
</body>